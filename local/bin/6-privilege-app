#!/bin/bash -e
APP_NAME="hello-world"

APP_HOST_NAME=$(cf env $APP_NAME | grep authn_login | awk '{print $NF}' | sed 's/host\///g; s/"//g; s/,$//g')
ESCAPED_HOST=$(echo $APP_HOST_NAME | sed 's/\//\\\//g')


if "$CONJUR_VERSION" -eq "5"
then
  api_key=$(docker-compose exec -T conjur_5 bash -c 'rails r "puts Role[%Q{default:user:pcf-admin}].api_key" 2>/dev/null')

  docker-compose run --rm \
    -e CONJUR_AUTHN_API_KEY="$api_key" \
    --entrypoint bash client -c "
      cat /policy/entitlements.yml | sed -e 's/<APP_HOST_NAME>/${ESCAPED_HOST}/' | conjur policy load root -
    "
else
  api_key=$(docker-compose exec -T conjur_4 su conjur -c "conjur-plugin-service authn env RAILS_ENV=appliance rails r \"puts User['pcf-admin'].api_key\" 2>/dev/null")

  docker-compose run --rm \
    -e CONJUR_AUTHN_LOGIN=pcf-admin \
    -e CONJUR_AUTHN_API_KEY=$api_key \
    -e ESCAPED_HOST=$ESCAPED_HOST \
    --entrypoint bash conjur_4 -c "
      replace="s/<APP_HOST_NAME>/$ESCAPED_HOST/";
      cat /etc/entitlements.yml | sed -e "$replace" | conjur policy load --as-group pcf-admin-group -
    "
fi
