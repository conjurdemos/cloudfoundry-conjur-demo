#!/bin/bash -e

api_key=$(docker-compose exec -T conjur bash -c 'rails r "puts Role[%Q{default:user:admin}].api_key" 2>/dev/null')

# load policy
docker-compose run --rm \
  -e CONJUR_AUTHN_API_KEY="$api_key" \
  --entrypoint bash client -c "
    conjur policy load --replace root /policy/root.yml
    conjur variable values add app/database/username 'a database username'
    conjur variable values add app/database/password 'a database password'
    conjur variable values add app/stripe/private_key 'a stripe private_key'
  "
