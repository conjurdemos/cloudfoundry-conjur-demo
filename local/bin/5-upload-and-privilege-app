#!/bin/bash -e
APP_NAME="hello-world"

api_key=$(docker-compose exec -T conjur bash -c 'rails r "puts Role[%Q{default:user:admin}].api_key" 2>/dev/null')

pushd ../app
  cf push --no-start

  # Bind done automatically during cf push due to app's manifest.yml file
  # cf bind-service $APP_NAME conjur
popd

# add entitlements
APP_HOST_NAME=$(cf env $APP_NAME | grep authn_login | awk '{print $NF}' | sed 's/host\///g; s/"//g')
docker-compose run --rm \
  -e CONJUR_AUTHN_API_KEY="$api_key" \
  --entrypoint bash client -c "
    cat /policy/entitlements.yml | sed -e 's/<APP_HOST_NAME>/${APP_HOST_NAME}/' | conjur policy load root -
  "

pushd ../app
  cf start $APP_NAME
popd
