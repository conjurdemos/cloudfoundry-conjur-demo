#!/bin/bash -e
APP_NAME="hello-world"

# get the Conjur service broker, upload to cf, and configure
curl -L $(curl -s https://api.github.com/repos/cyberark/conjur-service-broker/releases/latest | grep zipball_url | awk '{print $NF}' | sed 's/",*//g') > conjur-service-broker.zip
unzip conjur-service-broker.zip
repo_dir=$(ls | grep cyberark-conjur-service-broker)
mv $repo_dir conjur-service-broker

# push the SB app
pushd conjur-service-broker
  cf push --no-start --random-route
popd
rm -rf conjur-service-broker*

# get pcf-admin API key
if [[ "$CONJUR_VERSION" -eq "5" ]]
then
  api_key=$(docker-compose exec -T conjur_5 bash -c 'rails r "puts Role[%Q{default:user:pcf-admin}].api_key" 2>/dev/null')
  app_url="http://host.pcfdev.io"
  account="default"
  ssl_cert=""
else
  api_key=$(docker-compose exec -T conjur_4 su conjur -c "conjur-plugin-service authn env RAILS_ENV=appliance rails r \"puts User['pcf-admin'].api_key\" 2>/dev/null")
  app_url="https://host.pcfdev.io:8443/api"
  account="cucumber"
  ssl_cert="$(cat tmp/conjur.pem )"
fi

# configuring the SB env
cf set-env conjur-service-broker SECURITY_USER_NAME TEMPORARY
cf set-env conjur-service-broker SECURITY_USER_PASSWORD TEMPORARY
cf set-env conjur-service-broker CONJUR_ACCOUNT "$account"
cf set-env conjur-service-broker CONJUR_APPLIANCE_URL "$app_url"
cf set-env conjur-service-broker CONJUR_AUTHN_LOGIN pcf-admin
cf set-env conjur-service-broker CONJUR_AUTHN_API_KEY "$api_key"
cf set-env conjur-service-broker CONJUR_VERSION "$CONJUR_VERSION"
cf set-env conjur-service-broker CONJUR_POLICY pcf
cf set-env conjur-service-broker CONJUR_SSL_CERTIFICATE "$ssl_cert"

# start the SB app
cf start conjur-service-broker

# create the SB
APP_URL="http://`cf app conjur-service-broker | grep -E -w 'urls:|routes:' | awk '{print $2}'`"
cf create-service-broker conjur-service-broker "TEMPORARY" "TEMPORARY" $APP_URL --space-scoped

# create the service instance
cf create-service cyberark-conjur community conjur
