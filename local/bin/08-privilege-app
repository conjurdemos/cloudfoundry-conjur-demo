#!/bin/bash -e
APP_NAME="hello-world"

# get the host id, and then remove the cf policy prefix
# when we load the entitlement directly into the cf policy,
# the cf policy prefix is redundant
APP_HOST_NAME=$(cf env $APP_NAME | grep authn_login | awk '{print $NF}' | sed 's/host\///g; s/"//g; s/,$//g')
APP_HOST_NAME=$(echo $APP_HOST_NAME | sed 's/cf\///g')

api_key=$(docker-compose exec -T conjur_5 bash -c 'rails r "puts Role[%Q{default:host:cf-service-broker}].api_key" 2>/dev/null')

# load an entitlement into the cf policy
docker-compose run --rm \
  -e CONJUR_AUTHN_LOGIN="host/cf-service-broker" \
  -e CONJUR_AUTHN_API_KEY="$api_key" \
  --entrypoint bash client -c "
    cat /policy/app-entitlements.yml | sed -e 's~<APP_HOST_NAME>~${APP_HOST_NAME}~' | conjur policy load cf -
  "
