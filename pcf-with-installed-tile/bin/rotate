#!/bin/bash -e
APPEND_STRING=$1
APP_NAME="hello-world"

if [[ -z "$APPEND_STRING" ]]
  then
    APPEND_STRING=$RANDOM
fi

# rotate secret values
if [[ "$CONJUR_VERSION" -eq "5" ]]
then
  docker run -d -it -v $PWD:/work -w /work \
    -e CONJUR_AUTHN_API_KEY="$API_KEY" \
    -e CONJUR_AUTHN_LOGIN="admin" \
    -e CONJUR_ACCOUNT="$ACCOUNT" \
    -e CONJUR_APPLIANCE_URL="${APPLIANCE_URL:-'https://eval.conjur.org'}" \
    -e APPEND_STRING="$APPEND_STRING" \
    --entrypoint bash conjurinc/cli5 -c '
      conjur variable values add cf/org/database/username "org database username $APPEND_STRING";
      conjur variable values add cf/org/database/password "org database password $APPEND_STRING";
      
      conjur variable values add cf/space/database/username "space database username $APPEND_STRING";
      conjur variable values add cf/space/database/password "space database password $APPEND_STRING";

      conjur variable values add cf/app/database/username "app database username $APPEND_STRING";
      conjur variable values add cf/app/database/password "app database password $APPEND_STRING";
      conjur variable values add cf/app/stripe/private_key "a stripe private_key $APPEND_STRING"
    '
else
  conjur variable values add cf/app/database/username "a database username $APPEND_STRING"
  conjur variable values add cf/app/database/password "a database password $APPEND_STRING"
  conjur variable values add cf/app/stripe/private_key "a stripe private_key $APPEND_STRING"
fi

cf restage $APP_NAME

echo -e "\n\nThe secret values have been updated by appending '$APPEND_STRING'"
echo -e "\nThe app has been restaged, and it is now available at $(cf app $APP_NAME | grep routes | awk '{print $NF}')\n"
