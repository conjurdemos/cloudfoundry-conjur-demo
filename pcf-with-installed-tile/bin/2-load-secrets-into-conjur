#!/bin/bash -e

if [[ "$CONJUR_VERSION" -eq "5" ]]
then
  # get a Conjur CLI container running and load the root policy
  docker pull conjurinc/cli5
  docker run -d -it -v $PWD:/work -w /work \
    -e CONJUR_AUTHN_API_KEY="$API_KEY" \
    -e CONJUR_AUTHN_LOGIN="admin" \
    -e CONJUR_ACCOUNT="$ACCOUNT" \
    -e CONJUR_APPLIANCE_URL="eval.conjur.org" \
    --entrypoint bash cyberark/conjur-cli:5 -c '
      conjur policy load root policy/policy.yml
      conjur policy load root policy/cf_5.yml
      
      conjur policy load cf policy/org.yml
      conjur policy load cf policy/space.yml
      conjur policy load cf policy/app.yml
      
      conjur variable values add cf/org/database/username "organization database username"
      conjur variable values add cf/org/database/password "organization database password"

      conjur variable values add cf/space/database/username "space database username"
      conjur variable values add cf/space/database/password "space database password"

      conjur variable values add cf/app/database/username "a database username";
      conjur variable values add cf/app/database/password "a database password";
      conjur variable values add cf/app/stripe/private_key "a stripe private_key"
    '
else
  conjur policy load --as-group security_admin policy/policy.yml
  conjur policy load --as-group security_admin policy/cf_4.yml
  conjur variable values add cf/app/database/username 'a database username'
  conjur variable values add cf/app/database/password 'a database password'
  conjur variable values add cf/app/stripe/private_key 'a stripe private_key'
fi
