#!/bin/bash -e

POLICY_PREFIX="${POLICY_PREFIX:-'cf'}"

CONJUR_APPLIANCE_URL="${APPLIANCE_URL:-'https://eval.conjur.org'}"
CONJUR_APPLIANCE_HOST="${CONJUR_APPLIANCE_URL##*//}"

if [[ "${CONJUR_APPLIANCE_URL}" =~ ^https:// ]]; then
    CONJUR_SSL_CERTIFICATE=$(openssl s_client -showcerts -servername "$CONJUR_APPLIANCE_HOST" \
        -connect "${CONJUR_APPLIANCE_HOST}:443" < /dev/null 2> /dev/null \
        | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p')
fi

echo "$CONJUR_SSL_CERTIFICATE"

# get a Conjur CLI container running and load the root policy
docker pull conjurinc/cli5
docker run --rm -it -v $PWD:/work -w /work \
  -e CONJUR_AUTHN_API_KEY="$API_KEY" \
  -e CONJUR_AUTHN_LOGIN="admin" \
  -e CONJUR_ACCOUNT="$ACCOUNT" \
  -e CONJUR_APPLIANCE_URL="$CONJUR_APPLIANCE_URL" \
  -e CONJUR_SSL_CERTIFICATE="$CONJUR_SSL_CERTIFICATE" \
  -e CONJUR_APPLIANCE_URL="${APPLIANCE_URL:-'https://eval.conjur.org'}" \
  --entrypoint bash cyberark/conjur-cli:5 -ec "
    conjur policy load root policy/policy.yml
    conjur policy load root policy/cf.yml

    conjur policy load '$POLICY_PREFIX' policy/org.yml
    conjur policy load '$POLICY_PREFIX' policy/space.yml

    conjur variable values add $POLICY_PREFIX/org/database/username 'organization database username'
    conjur variable values add $POLICY_PREFIX/org/database/password 'organization database password'

    conjur variable values add $POLICY_PREFIX/space/database/username 'space database username'
    conjur variable values add $POLICY_PREFIX/space/database/password 'space database password'
  "
