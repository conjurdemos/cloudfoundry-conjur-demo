#!/bin/bash -e

APP_NAME="hello-world"
APP_HOST_NAME=$(cf env $APP_NAME | grep authn_login | awk '{print $NF}' | sed 's/host\/pcf\///g; s/"//g; s/,$//g')

# add an entitlement for the new host
if [[ "$CONJUR_VERSION" -eq "5" ]]
then
  docker run -d -it -v $PWD:/work -w /work \
    -e CONJUR_AUTHN_API_KEY="$API_KEY" \
    -e CONJUR_AUTHN_LOGIN="admin" \
    -e CONJUR_ACCOUNT="$ACCOUNT" \
    -e CONJUR_APPLIANCE_URL="eval.conjur.org" \
    -e APP_HOST_NAME="$APP_HOST_NAME" \
    --entrypoint bash conjurinc/cli5 -c '
      replace="s/<APP_HOST_NAME>/$APP_HOST_NAME/";
      cat policy/entitlements.yml | sed -e "$replace" | conjur policy load pcf -
    '
else
  replace="s|<APP_HOST_NAME>|$APP_HOST_NAME|";
  pushd policy
    cat ./pcf_4_with_entitlement.yml | sed -e "$replace" | conjur policy load --as-group pcf-admin-group
  popd
fi
