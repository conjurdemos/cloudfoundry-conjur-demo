#!/bin/bash -e
BIN_DIR=$(cd "$(dirname $0)/."  && pwd)
ROOT_DIR=$BIN_DIR/../
APP_NAME="hello-world"

# stop will make sure PCFDev is running and the `cf` binary is installed
./bin/stop

docker-compose up -d conjur pg

cf create-space demo
cf target -s demo

rm -rf meta-buildpack
git clone https://github.com/cf-platform-eng/meta-buildpack.git
pushd meta-buildpack
  ./build
  ./upload
popd
rm -rf meta-buildpack

rm -rf cloudfoundry-conjur-buildpack
git clone git@github.com:conjurinc/cloudfoundry-conjur-buildpack.git
pushd cloudfoundry-conjur-buildpack
  ./upload
popd
rm -rf cloudfoundry-conjur-buildpack

rm -rf conjur-service-broker
git clone git@github.com:conjurinc/conjur-service-broker.git
pushd conjur-service-broker
  cf push --no-start --random-route

  printf "Waiting for API key... "
  while [[ ! -f $ROOT_DIR/tmp/api_key ]]
  do
    sleep 1
  done

  while [[ -z `cat $ROOT_DIR/tmp/api_key` ]]
  do
    sleep 1
  done
  echo "Done."

  cf set-env conjur-service-broker CONJUR_ACCOUNT default
  cf set-env conjur-service-broker CONJUR_APPLIANCE_URL http://192.168.11.1:3000
  cf set-env conjur-service-broker CONJUR_AUTHN_LOGIN admin
  cf set-env conjur-service-broker CONJUR_AUTHN_API_KEY "$(cat $ROOT_DIR/tmp/api_key)"

  cf start conjur-service-broker

  APP_URL="http://`cf app conjur-service-broker | grep -E -w 'urls:|routes:' | awk '{print $2}'`"
  cf create-service-broker conjur-service-broker "TEMPORARY" "TEMPORARY" $APP_URL --space-scoped

  printf "Waiting for Conjur to be ready... "
  while [[ ! `curl -X HEAD -is localhost:3000 | head -n1 | awk '{print $2}'` -eq '200' ]]
  do
    sleep 1
  done
  echo "Done."

  cf create-service cyberark-conjur default conjur
popd
rm -rf conjur-service-broker

pushd app
  cf push --no-start
popd

# run policy
APP_HOST_NAME=$(cf env $APP_NAME | grep authn_login | awk '{print $NF}' | sed 's/host\///g; s/"//g')
docker-compose run --rm -e CONJUR_AUTHN_API_KEY="$(cat $ROOT_DIR/tmp/api_key)" --entrypoint bash client -c "
cat /policy/root.yml | sed -e 's/<APP_HOST_NAME>/${APP_HOST_NAME}/' | conjur policy load root -
conjur variable values add app/database/username 'a database username'
conjur variable values add app/database/password 'a database password'
conjur variable values add app/stripe/private_key 'a stripe private_key'
"

pushd app
  cf start $APP_NAME
popd
