#!/bin/bash -e

# stop will make sure PCFDev is running and the `cf` binary is installed
./bin/stop

# get a Conjur CLI container running and load the root policy
docker pull conjurinc/cli5
docker run -d -it -v $PWD:/work -w /work \
  -e CONJUR_AUTHN_API_KEY="$API_KEY" \
  -e CONJUR_AUTHN_LOGIN="admin" \
  -e CONJUR_ACCOUNT="$ACCOUNT" \
  -e CONJUR_APPLIANCE_URL="eval.conjur.org" \
  --entrypoint bash conjurinc/cli5 -c '
    cat policy/root.yml | sed -e "$replace" | conjur policy load --replace root -;
    conjur variable values add app/database/username "a database username";
    conjur variable values add app/database/password "a database password";
    conjur variable values add app/stripe/private_key "a stripe private_key"
  '

cf create-org cyberark
cf target -o cyberark
cf create-space cyberark-conjur-demo
cf target -s cyberark-conjur-demo